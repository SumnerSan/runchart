---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```
## Please note
This package is under construction; functionality may change. If this project is of interest to you please get in touch; I'm keen to hear feedback and may be able to incorporate your specific needs into the package.

## Introduction

>Because they are simple to make and relatively straightforward to interpret, run charts are one of the most useful tools in quality improvement. - [NHS Scotland Quality Improvement Hub](http://www.qihub.scot.nhs.uk/knowledge-centre/quality-improvement-tools/run-chart.aspx).

Run charts^[As defined by the NHS Scotland Quality Improvement Hub] are non-trivial to automate. A number of solutions exist in the healthcare improvement community in Scotland. However the author is only aware of small-scale solutions such as scripts and Excel macros.

These kinds of approaches have the following limitations:

* Version control is cumbersome and unrealistic.
* Adding a separate script to an existing workflow is inconvenient and error prone.
* Scripts are often written to operate under specific conditions; making wider adoption unlikely.
* Testing edge cases is a time consuming task which is replicated with each new script or macro.

The `runchart` package aims to overcome these limitations by exporting a small number of easy to use and well tested functions.

## Getting Started
To download the package first ensure you are not behind a firewall or using a VPN^[These can block installation from GitHub]. Install the package using `install_github()`^[You may need to install the `devtools` package first.]:

```
devtools::install_github('josephjosephadams/runchart')
```

The easiest place to start is with `rc_plot()`. This function takes a data frame with two columns: date and value:

```{r, warning = FALSE, fig.width = 7, fig.align = 'center'}
library(runchart)
library(ggplot2)

n     <- 30
date  <- seq.Date(Sys.Date(), by = "day", length.out = n)
value <- c(0,1,5,2,3,8,2,2,3,4,7,4,3,4,2,3,1,2,3,2,8,9,7,8,7,9,NA,7,7,8)

df    <- data.frame(date  = date,
                    value = value)

rc_plot(df)
```

### Things to Notice
There are several behaviours to notice in the plot above:

* **Rephasing** for each sustained shift (9 consecutive points all above/below the baseline).

* **Shifts** are identified (6 or more consecutive points all above/below the baseline).

* **Missing values** are ignored. For example the 27th data point above is missing, which causes the rephased baseline to be longer than the first.

* **Non-useful observations** are ignored. For example the 15th data point above lands exactly on the first baseline. Therefore it neither breaks nor contributes to the observed shift.

The functions exported by the `runchart` package have been well tested using the `testthat` package to correctly handle such different scenarios and edge cases.

### Accessing the Numbers
If you need the fields that sit behind the run chart plot: use `rc_fields()`:

```{r, warning = FALSE}
head(rc_fields(value))
```

The columns `base` and `base_ext` are used for the thick and thin black lines in the plot above. The `base_label` column is used for labelling new baselines. The `shift` and `val` columns are used to plot shifts and the original data.

## Different Methodologies
There is no fixed methodology for creating run charts. Here are some functions which should help you apply a range of methodologies.

### Single Baseline
If you require a single baseline with shifts and trends, you can use the `basic_shift()` and `basic_trend()` functions:

```{r, warning = FALSE, fig.width = 7, fig.align = 'center'}

value <- c(0,1,5,2,3,8,2,2,3,4,7,4,3,4,2,3,3,4,6,8,8,9,7,8,7,9,NA,7,7,8)
base  <- median(value, na.rm = T)

# `basic_shift()` and `basic_trend()` return the indices of shifts and trends
shift       <- trend <- value*NA
shift_index <- basic_shift(base = base, val = value)
trend_index <- basic_trend(val = value)

shift[shift_index] <- value[shift_index]
trend[trend_index] <- value[trend_index]
base  <- rep(base, length(value))

rc_fields <- data.frame(date  = date,
                        value = value,
                        base  = base,
                        shift = shift,
                        trend = trend)

ggplot(rc_fields, aes(date, value)) +
  geom_line(colour = 'skyblue', size = 1.1) +
  geom_line(aes(y = base)) +
  geom_line(colour = 'blue', aes(y = trend), size = 1.1) +
  geom_point(aes(y = shift), shape = 16, size = 2, colour = 'black',
               stroke = 2) +
  theme_classic() + theme(axis.title.x=element_blank(),
                              axis.title.y=element_blank(),
                              axis.ticks.x=element_blank(),
                              axis.ticks.y=element_blank())
```
